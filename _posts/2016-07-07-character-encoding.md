---
layout: post
title: 字符编码
subline: Character Encoding
categories: frontend
tags: [gitlab, git, nginx]
---

「字符与编码」是一个被经常讨论的话题。即使这样，时常出现的乱码仍然困扰着大家。虽然我们有很多的办法可以用来消除乱码，但我们并不一定理解这些办法的内在原理。而有的乱码产生的原因，实际上由于底层代码本身有问题所导致的。因此，不仅是初学者会对字符编码感到模糊，有的底层开发人员同样对字符编码缺乏准确的理解。

## 字符编码的前世今生

### 古代的通信方式
很久很久以前，人们之间的长途通讯主要是用信鸽、骑马送报、烽烟等方式进行，不过这些方式无不例外都是出奇的慢，同时也受天气、地理等因素的影响。

### 摩尔斯电码
直到1837年，世界第一条电报诞生，当时美国科学家摩尔斯尝试用一些「点」和「划」来表示不同的字母、数字和标点符号，这套表示字符的方式也被称为「摩尔斯电码」：

> ![国际摩尔斯电码](https://upload.wikimedia.org/wikipedia/commons/9/93/%E5%9B%BD%E9%99%85%E6%91%A9%E5%B0%94%E6%96%AF%E7%94%B5%E7%A0%81.svg)
> FROM:[维基百科 - 摩尔斯电码](https://zh.wikipedia.org/wiki/%E6%91%A9%E5%B0%94%E6%96%AF%E7%94%B5%E7%A0%81)

### 世界第一台计算机
再后来到了1946年，世界第一台计算机诞生。发明计算机的同学们用8个晶体管的「通」或「断」组合出一些状态来表示世间万物。

这部机器使用了18800个真空管，长50英尺，宽30英尺， 占地1500平方英尺，重达30吨（大约是一间半的教室大，六只大象重）。从现在看来这简直就是个怪物，但在当时却是震惊世界与改变世界的一项重要发明。

### ASCII

8个晶体管的「通」或「断」即可以代表一个字节。在计算机内部，所有的信息都是以二进制（0和1两种不同的状态）的方式存储。

而每一个二进制位（bit）有0和1两种状态，因此八个二进制位就可以组合出256种状态，这被称为一个字节（byte）。也就是说，一个字节一共可以用来表示256种不同的状态，每一个状态对应一个符号，就是256个符号，从0000000到11111111。

上个世纪60年代，美国制定了一套字符编码，他们尝试把一些计算机终端的动作、字母、数字和符号用8位(bit)来组合。这被称为ASCII码，一直沿用至今：

> ![](http://www.asciima.com/img/ascii_Table2.png)
> FROM：[ASCII码中文站](http://www.asciima.com/)


在 ASCII 阶段，单字节字符串使用一个字节存放一个字符（SBCS）。比如，「Bob123」在内存中为：

    0x  42  6F  62  31  32  33  00
        --------------------------
        B   o   b   1   2   3   \0

### EASCII

虽然刚开始计算机只在美国使用，128个字符的确是足够了，但随着科技惊人的发展，欧洲国家也开始使用上计算机了。这样128个字符明显不够了，比如法语中，字母上方有注音符号，于是，一些欧洲国家就决定，利用字节中闲置的最高位编入新的符号。比如，法语的é的二进制流为1000 0010，这样一来，这些欧洲国家的编码体系，可以表示最多256个字符了。

但是，这里又出现了新的问题。不同的国家有不同的字母，因此，哪怕它们都使用256个符号的编码方式，代表的字母却不一样。比如，1000 0010在法语编码中代表了é，在希伯来语编码中却代表了字母Gimel (ג)，在俄语编码中又会代表另一个符号。但是不管怎样，所有这些编码方式中，0–127表示的符号是一样的，不一样的只是128–255的这一段。

EASCII（Extended ASCII，延伸美国标准信息交换码）由此应运而生:

> ![](http://www.asciima.com/img/ascii127-255.jpg)
> FROM：[ASCII码中文站](http://www.asciima.com/)


### GB2312

EASCII码对于部分欧洲国家基本够用了，但过后的不久，计算机便来到了天朝，要知道汉字是世界上包含符号最多并且也是最难学的文字。

据不完全统计，汉字共包含了古文、现代文字等近10万个文字，就是我们现在日常用的汉字也有几千个，那么对于只包含256个字符的EASCII码也难以满足天朝的需求了。

于是天朝专家把那些127号之后的奇异符号们（即EASCII）取消掉，并且规定：一个小于127的字符的意义与原来相同，但两个大于127的字符连在一起时，就表示一个汉字，前面的一个字节（他称之为高字节）从0xA1用到 0xF7，后面一个字节（低字节）从0xA1到0xFE因此，这种方式存放的字符也被称作**多字节字符**。

这样我们就可以组合出大约7000多个简体汉字了。在这些编码里，还把数学符号、罗马希腊的 字母、日文的假名们都编进去了，连在ASCII里本来就有的数字、标点、字母都统统重新编了两个字节长的编码，这就是常说的「全角」字符，而原来在127号以下的那些就叫「半角」字符了。


比如，「中文123」在中文 Windows 95 内存中为7个字节，每个汉字占2个字节，每个英文和数字字符占1个字节：

    0x  D6  D0 CE  C4  31  32  33  00
        ------ ------ ---------------
          中     文     1   2   3   \0

- 包括：共包含7445个字符，6763个汉字和682个其他字符（拉丁字母、希腊字母、日文平假名及片假名字母、俄语西里尔字母）
- 注意：既然说了是简化汉字，那就说明繁/正体字、日语、朝鲜语不在收录范围之内啦，另外还有部分简体字也未收录，如朱镕基的镕字，还有古汉语等罕见字也未收录。
- 编码方式：双字节表示一个字符

### BIG5

要知道港澳台同胞使用的是繁体字，而中国大陆制定的GB2312编码并不包含繁体字，于是信息工业策进会在1984年与台湾13家厂商签定《16位个人电脑套装软件合作开发（BIG-5）计划》，并开始编写并推出BIG5标准。

之后推出的倚天中文系统则基于BIG5码，并在台湾地区取得了巨大的成功。在BIG5诞生后，大部分的电脑软件都使用了Big5码，BIG5对于以台湾为核心的亚洲繁体汉字圈产生了久远的影响，以至于后来的 windows 繁体中文版系统在台湾地区也基于BIG5码进行开发。

- 包括：共收录13,060个汉字及441个符号
- 编码方式：用两个字节来为每个字符编码，第一个字节称为「高位字节」，第二个字节称为「低位字节」

### ANSI编码（本地化）

不同的国家和地区制定了不同的标准，由此产生了 GB2312, BIG5, JIS 等各自的编码标准。这些使用 2 个字节来代表一个字符的各种汉字延伸编码方式，称为 ANSI 编码。在简体中文系统下，ANSI 编码代表 GB2312 编码，在日文操作系统下，ANSI 编码代表 JIS 编码。

不同 ANSI 编码之间互不兼容，当信息在国际间交流时，无法将属于两种语言的文字，存储在同一段 ANSI 编码的文本中。

## 伟大的创想Unicode

在计算机进入中国大陆的相同时期，计算机也迅速发展进入了世界各个国家。

特别是对于亚洲国家而言，每个国家都有自己的文字，于是每个国家或地区都像中国大陆这样去制定了自己的编码标准，以便能在计算机上正确显示自己国家的符号。

但带来的结果就是国家之间谁也不懂别人的编码，谁也不支持别人的编码，连大陆和台湾这样只相隔了150海里，都使用了不同的编码体系。

为了解决这个问题，一个伟大的创想产生了 —— Unicode。

Unicode编码系统为表达任意语言的任意字符而设计。它使用4字节的数字来表达每个字母、符号，或者表意文字(ideograph)。每个数字代表唯一的至少在某种语言中使用的符号。（并不是所有的数字都用上了，但是总数已经超过了65535，所以2个字节的数字是不够用的。）被几种语言共用的字符通常使用相同的数字来编码，除非存在一个在理的语源学(etymological)理由使不这样做。不考虑这种情况的话，每个字符对应一个数字，每个数字对应一个字符。即不存在二义性。不再需要记录「模式」了。U+0041总是代表「A」，即使这种语言没有「A」这个字符。

在计算机科学领域中，Unicode（统一码、万国码、单一码、标准万国码）是业界的一种标准，它可以使电脑得以体现世界上数十种文字的系统。Unicode伴随着通用字符集的标准而发展，同时也以书本的形式对外发表。Unicode至今仍在不断增修，每个新版本都加入更多新的字符。目前最新的版本为2016年6月21日公布的9.0.0，已经收入超过十万个字符（第十万个字符在2005年获采纳）。Unicode涵盖的数据除了视觉上的字形、编码方法、标准的字符编码外，还包含了字符特性，如大小写字母。

Unicode 组织（The Unicode Consortium）是由一个非营利性的机构所运作，并主导 Unicode 的后续发展，其目标在于：将既有的字符编码方案以Unicode 编码方案来加以取代，特别是既有的方案在多语环境下，皆仅有有限的空间以及不兼容的问题。

（可以这样理解：Unicode是字符集，UTF-32、UTF-16、UTF-8是三种字符编码方案。）

在 UNICODE 被采用之后，计算机存放字符串时，改为存放每个字符在 UNICODE 字符集中的序号。目前计算机一般使用 2 个字节（16 位）来存放一个序号（DBCS），因此，这种方式存放的字符也被称作宽字节字符。比如，字符串 "中文123" 在 Windows 2000 下，内存中实际存放的是 5 个序号：

        2D  4E 87  65 31  00 32  00 33  00 00  00  // 在 x86 CPU 中，低字节在前
        ------ ------ ------ ------ ------ ------
          中      文     1      2      3     \0

一共占 10 个字节。

### Unicode的问题

需要注意的是，Unicode只是一个符号集，它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。
比如，汉字「严」的unicode是十六进制数4E25，转换成二进制数足足有15位（100111000100101），也就是说这个符号的表示至少需要2个字节。表示其他更大的符号，可能需要3个字节或者4个字节，甚至更多。

这里就有两个严重的问题，第一个问题是，如何才能区别Unicode和ASCII？计算机怎么知道三个字节表示一个符号，而不是分别表示三个符号呢？第二个问题是，我们已经知道，英文字母只用一个字节表示就够了，如果Unicode统一规定，每个符号用三个或四个字节表示，那么每个英文字母前都必然有二到三个字节是0，这对于存储来说是极大的浪费，文本文件的大小会因此大出二三倍，这是无法接受的。

它们造成的结果是：

1. 出现了Unicode的多种存储方式，也就是说有许多种不同的二进制格式，可以用来表示Unicode。
2. Unicode在很长一段时间内无法推广，直到互联网的出现。

### UTF-8

互联网的普及，强烈要求出现一种统一的编码方式。UTF-8就是在互联网上使用最广的一种Unicode的实现方式。其他实现方式还包括UTF-16（字符用两个字节或四个字节表示）和UTF-32（字符用四个字节表示），不过在互联网上基本不用。重复一遍，这里的关系是，UTF-8是Unicode的实现方式之一。

UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，根据不同的符号而变化字节长度。

UTF-8的编码规则很简单，只有二条：

1. 对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。
2. 对于n字节的符号（n>1），第一个字节的前n位都设为1，第n+1位设为0，除了第一个字节外，其余字节的头两个比特都是以「10」开始，使文字处理器能够较快地找出每个字符的开始位置。剩下的没有提及的二进制位，全部为这个符号的unicode码。

下表总结了编码规则，字母x表示可用编码的位。

码点的位数 | 码点起值  |  码点终值  |  字节序列  |  Byte 1  | Byte 2  | Byte 3   | Byte 4   | Byte 5   | Byte 6
:-------:|:--------:|:---------:|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:|:--------:
7        | U+0000   | U+007F    | 1        | 0xxxxxxx |||||
11       | U+0080   | U+07FF    | 2        | 110xxxxx | 10xxxxxx ||||
16       | U+0800   | U+FFFF    | 3        | 1110xxxx | 10xxxxxx | 10xxxxxx |
21       | U+10000  | U+1FFFFF  | 4        | 11110xxx | 10xxxxxx | 10xxxxxx | 10xxxxxx |
26       | U+200000  | U+3FFFFFF | 5       | 111110xx | 10xxxxxx | 10xxxxxx | 10xxxxxx | 10xxxxxx |
31       | U+4000000 | U+7FFFFFFF | 6      | 1111110x | 10xxxxxx | 10xxxxxx | 10xxxxxx | 10xxxxxx |  10xxxxxx


### 参考链接：

- [字符，字节和编码](http://www.regexlab.com/zh/encoding.htm)
- [The Unicode Consortium](http://www.unicode.org/)
- [1946年2月14日 世界上第一台计算机诞生](http://www.people.com.cn/GB/historic/0214/5790.html)
- [ASCII码中文站](http://www.asciima.com/)
- [Unicode](https://zh.wikipedia.org/wiki/Unicode)